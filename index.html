<!DOCTYPE html>
<html>

<head>
    <title>پلک جھپکنے سے کمانڈ</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <style>
        video,
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #message {
            position: absolute;
            top: 400px;
            font-size: 28px;
            background: lightyellow;
            padding: 10px;
        }
    </style>
</head>

<body>
    <video id="video" width="640" height="480" autoplay muted></video>
    <canvas id="overlay" width="640" height="480"></canvas>
    <div id="message">ابھی تک پلک نہیں جھپکی گئی</div>

    <script>
        const video = document.getElementById('video');
        const message = document.getElementById('message');
        let blinkCount = 0;
        let lastState = 'open';

        async function start() {
            await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
            await faceapi.nets.faceLandmark68TinyNet.loadFromUri('/models');

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => video.srcObject = stream);

            video.addEventListener('play', () => {
                const canvas = document.getElementById('overlay');
                const displaySize = { width: video.width, height: video.height };
                faceapi.matchDimensions(canvas, displaySize);

                setInterval(async () => {
                    const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks(true);

                    if (detections) {
                        const landmarks = detections.landmarks;
                        const leftEye = landmarks.getLeftEye();
                        const rightEye = landmarks.getRightEye();

                        const eyeOpenness = getEyeOpenness(leftEye) + getEyeOpenness(rightEye);

                        if (eyeOpenness < 0.25 && lastState === 'open') {
                            blinkCount++;
                            lastState = 'closed';
                            message.innerText = `پلک جھپکنے کا سگنل ملا: ${blinkCount}`;
                        } else if (eyeOpenness >= 0.25) {
                            lastState = 'open';
                        }
                    }
                }, 100);
            });
        }

        function getEyeOpenness(eye) {
            const vertical = Math.hypot(eye[1].y - eye[5].y) + Math.hypot(eye[2].y - eye[4].y);
            const horizontal = Math.hypot(eye[0].x - eye[3].x);
            return vertical / (2.0 * horizontal);
        }

        start();


        await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
        await faceapi.nets.faceLandmark68TinyNet.loadFromUri('/models');

    </script>
</body>

</html>